<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mogul Crush</title>
<style>
    body {
        background: #ffe6f0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        font-family: Arial, sans-serif;
    }
    #score {
        font-size: 24px;
        font-weight: bold;
        color: #ff4081;
        margin: 10px;
    }
    #game-container {
        width: 240px;
        height: 240px;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-template-rows: repeat(4, 1fr);
        gap: 2px;
        background: #fff;
        border: 5px solid #ff4081;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        padding: 5px;
        position: relative;
    }
    .cell {
        width: 100%;
        height: 100%;
        border-radius: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: grab;
        background: #fff5f8;
        position: relative;
        overflow: hidden;
    }
    .cell img {
        width: 90%;
        height: auto;
        pointer-events: none;
        user-select: none;
        transition: transform 0.2s ease, opacity 0.3s ease, top 0.3s ease;
        position: relative;
    }
    .matched img {
        opacity: 0;
        transform: scale(0.5);
    }
    #cta {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 20px;
        font-weight: bold;
        color: #fff;
        background: #ff4081;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }
    #cta:hover {
        background: #e33670;
    }
</style>
</head>
<body>

<div id="score">Puntos: 0</div>
<div id="game-container"></div>
<button id="cta" onclick="window.open('https://www.arcor.com.uy/productos/mogul', '_blank')">Comprar Mogul</button>

<script>
const gridSize = 4;
const candies = ["osito.png", "banana.png", "fresa.png", "mora.png"];
let grid = [];
let score = 0;

function createBoard() {
    const container = document.getElementById("game-container");
    container.innerHTML = "";
    grid = [];
    for (let i = 0; i < gridSize * gridSize; i++) {
        const cell = document.createElement("div");
        cell.classList.add("cell");
        addRandomCandy(cell);
        cell.setAttribute("draggable", true);
        cell.dataset.index = i;
        container.appendChild(cell);
        grid.push(cell);
    }
    stabilizeBoard();
}

function addRandomCandy(cell) {
    const candy = document.createElement("img");
    candy.src = candies[Math.floor(Math.random() * candies.length)];
    cell.appendChild(candy);
}

function stabilizeBoard() {
    while (findMatches().length > 0) {
        let matches = findMatches();
        matches.forEach(i => {
            let img = grid[i].querySelector("img");
            if (img) img.remove();
            addRandomCandy(grid[i]);
        });
    }
}

let draggedCell = null;

document.addEventListener("dragstart", e => {
    if (e.target.classList.contains("cell")) {
        draggedCell = e.target;
    } else if (e.target.tagName === "IMG") {
        draggedCell = e.target.parentElement;
    }
});
document.addEventListener("dragover", e => e.preventDefault());
document.addEventListener("drop", e => {
    let targetCell = e.target.closest(".cell");
    if (draggedCell && targetCell && draggedCell !== targetCell) {
        swapCandies(draggedCell, targetCell);
        processBoard();
        draggedCell = null;
    }
});

function swapCandies(a, b) {
    const imgA = a.querySelector("img");
    const imgB = b.querySelector("img");
    if (imgA && imgB) {
        const temp = imgA.src;
        imgA.src = imgB.src;
        imgB.src = temp;
    }
}

function findMatches() {
    let matched = [];
    // Horizontal
    for (let r = 0; r < gridSize; r++) {
        for (let c = 0; c < gridSize - 2; c++) {
            let idx = r * gridSize + c;
            let candy1 = grid[idx].querySelector("img")?.src;
            let candy2 = grid[idx + 1].querySelector("img")?.src;
            let candy3 = grid[idx + 2].querySelector("img")?.src;
            if (candy1 && candy2 && candy3 && candy1 === candy2 && candy2 === candy3) {
                matched.push(idx, idx + 1, idx + 2);
            }
        }
    }
    // Vertical
    for (let c = 0; c < gridSize; c++) {
        for (let r = 0; r < gridSize - 2; r++) {
            let idx = r * gridSize + c;
            let candy1 = grid[idx].querySelector("img")?.src;
            let candy2 = grid[idx + gridSize].querySelector("img")?.src;
            let candy3 = grid[idx + 2 * gridSize].querySelector("img")?.src;
            if (candy1 && candy2 && candy3 && candy1 === candy2 && candy2 === candy3) {
                matched.push(idx, idx + gridSize, idx + 2 * gridSize);
            }
        }
    }
    return [...new Set(matched)];
}

function processBoard() {
    let matches = findMatches();
    if (matches.length > 0) {
        // sumar puntos solo si hay 3 o más
        score += matches.length * 10;
        document.getElementById("score").innerText = "Puntos: " + score;
        // eliminar por completo las imágenes
        matches.forEach(i => {
            let img = grid[i].querySelector("img");
            if (img) img.remove();
        });
        setTimeout(() => {
            applyGravity();
            refillBoard();
            processBoard();
        }, 300);
    }
}

function applyGravity() {
    for (let c = 0; c < gridSize; c++) {
        let emptySpot = gridSize - 1;
        for (let r = gridSize - 1; r >= 0; r--) {
            let idx = r * gridSize + c;
            if (!grid[idx].querySelector("img")) {
                continue;
            }
            if (emptySpot !== r) {
                // mover la imagen
                let currentImg = grid[idx].querySelector("img");
                if (currentImg) {
                    grid[emptySpot * gridSize + c].appendChild(currentImg);
                }
            }
            emptySpot--;
        }
        // eliminar imágenes duplicadas en filas vacías
        for (let r = emptySpot; r >= 0; r--) {
            let idx = r * gridSize + c;
            let img = grid[idx].querySelector("img");
            if (img) img.remove();
        }
    }
}

function refillBoard() {
    grid.forEach(cell => {
        if (!cell.querySelector("img")) {
            addRandomCandy(cell);
        }
    });
}

createBoard();

</script>
</body>
</html>
