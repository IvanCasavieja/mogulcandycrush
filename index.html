<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Mogul Crush</title>
  <meta name="ad.size" content="width=300,height=250" />

  <!-- Preload de la fuente (desde la raíz hacia /Sunbeat) -->
  <link rel="preload" href="Sunbeat/Sunbeat.woff2" as="font" type="font/woff2" crossorigin>

  <!-- CSS con @font-face y estilos globales -->
  <link rel="stylesheet" href="Sunbeat/style.css">

  <script src="https://s0.2mdn.net/ads/studio/Enabler.js"></script>
</head>

<body>
  <div id="score">Puntos: 0</div>
  <div id="game-container">
    <div id="tutorial-hand"></div>
  </div>
  <button id="cta">Comprar Mogul</button>

  <script>
    // ======= CONFIG =======
    const gridSize = 5; // <- tamaño del tablero (4, 5, 6, ...)
    const candies = [
      "Jelly/Amarillo.png",
      "Jelly/Celeste.png",
      "Jelly/Rojo.png",
      "Jelly/Verde.png",
      "Jelly/Violeta.png"
    ];

    // ======= STATE =======
    let grid = [];
    let score = 0;

    // Bloquear drag nativo
    document.addEventListener("dragstart", e => e.preventDefault());

    // Enabler
    function enablerInitHandler() {
      document.getElementById("cta").addEventListener("click", () => Enabler.exit("ClickThrough"));
    }
    if (typeof Enabler !== "undefined" && Enabler.isInitialized()) enablerInitHandler();
    else if (typeof Enabler !== "undefined") Enabler.addEventListener(studio.events.StudioEvent.INIT, enablerInitHandler);

    // ======= BOARD =======
    function createBoard() {
      const container = document.getElementById("game-container");
      container.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
      container.style.gridTemplateRows = `repeat(${gridSize}, 1fr)`;

      // Limpiar y reconstruir
      container.querySelectorAll(".cell").forEach(c => c.remove());
      grid = [];

      for (let i = 0; i < gridSize * gridSize; i++) {
        const cell = document.createElement("div");
        cell.classList.add("cell");
        addRandomCandy(cell);
        container.appendChild(cell);
        grid.push(cell);
      }
      stabilizeBoard();
      positionTutorialHand();
    }

    function addRandomCandy(cell) {
      const img = document.createElement("img");
      img.src = candies[Math.floor(Math.random() * candies.length)];
      cell.appendChild(img);
    }

    // Evitar que el tablero nazca con matches
    function stabilizeBoard() {
      let loop = 0;
      while (true) {
        const m = findMatches();
        if (!m.length) break;
        m.forEach(i => {
          const img = grid[i].querySelector("img");
          if (img) img.remove();
          addRandomCandy(grid[i]);
        });
        if (++loop > 50) break; // safety
      }
    }

    // ======= MATCH DETECTION =======
    function findMatches() {
      const matched = [];

      // Horizontales
      for (let r = 0; r < gridSize; r++) {
        for (let c = 0; c < gridSize - 2; c++) {
          const idx = r * gridSize + c;
          const a = grid[idx].querySelector("img")?.src;
          const b = grid[idx + 1].querySelector("img")?.src;
          const d = grid[idx + 2].querySelector("img")?.src;
          if (a && a === b && b === d) matched.push(idx, idx + 1, idx + 2);
        }
      }
      // Verticales
      for (let c = 0; c < gridSize; c++) {
        for (let r = 0; r < gridSize - 2; r++) {
          const idx = r * gridSize + c;
          const a = grid[idx].querySelector("img")?.src;
          const b = grid[idx + gridSize].querySelector("img")?.src;
          const d = grid[idx + 2 * gridSize].querySelector("img")?.src;
          if (a && a === b && b === d) matched.push(idx, idx + gridSize, idx + 2 * gridSize);
        }
      }
      return [...new Set(matched)];
    }

    function processBoard() {
      const matches = findMatches();
      if (!matches.length) return;

      score += matches.length * 10;
      document.getElementById("score").textContent = "Puntos: " + score;

      matches.forEach(i => {
        createParticles(grid[i]);
        const img = grid[i].querySelector("img");
        if (img) img.remove();
      });

      setTimeout(() => {
        applyGravity();
        refillBoard();
        processBoard(); // recursivo hasta que no haya más matches
      }, 300);
    }

    function applyGravity() {
      for (let c = 0; c < gridSize; c++) {
        let empty = gridSize - 1;
        for (let r = gridSize - 1; r >= 0; r--) {
          const idx = r * gridSize + c;
          const hasImg = !!grid[idx].querySelector("img");
          if (!hasImg) continue;

          if (empty !== r) {
            const img = grid[idx].querySelector("img");
            if (img) grid[empty * gridSize + c].appendChild(img);
          }
          empty--;
        }
        // limpiar restos encima de 'empty'
        for (let r = empty; r >= 0; r--) {
          const idx = r * gridSize + c;
          const img = grid[idx].querySelector("img");
          if (img) img.remove();
        }
      }
    }

    function refillBoard() {
      grid.forEach(cell => { if (!cell.querySelector("img")) addRandomCandy(cell); });
    }

    // ======= FX =======
    function createParticles(cell) {
      const colors = ["#fff176", "#ff8a80", "#80d8ff", "#b9f6ca", "#ff4081", "#ffea00", "#00e676", "#651fff"];
      for (let i = 0; i < 8; i++) {
        const p = document.createElement("div");
        p.style.position = "absolute";
        p.style.width = "10px";
        p.style.height = "10px";
        p.style.background = colors[Math.floor(Math.random() * colors.length)];
        p.style.borderRadius = "50%";
        p.style.left = "50%";
        p.style.top = "50%";
        p.style.opacity = "1";
        p.style.transform = "translate(-50%,-50%)";
        p.style.transition = "all .8s ease-out";
        cell.appendChild(p);

        requestAnimationFrame(() => {
          p.style.left = `${Math.random() * 100}%`;
          p.style.top = `${Math.random() * 100}%`;
          p.style.opacity = "0";
        });
        setTimeout(() => p.remove(), 820);
      }
    }

    // ======= INPUT (swap sencillo) =======
    let startCell = null;
    document.addEventListener("mousedown", e => {
      const cell = e.target.closest(".cell");
      if (cell) { startCell = cell; cell.classList.add("pressed"); }
    });
    document.addEventListener("mouseup", e => {
      const target = e.target.closest(".cell");
      if (startCell && target && startCell !== target) {
        swapCandies(startCell, target);
        hideTutorial();
        processBoard();
      }
      if (startCell) startCell.classList.remove("pressed");
      startCell = null;
    });

    // Touch
    let touchStartCell = null;
    document.addEventListener("touchstart", e => {
      const cell = e.target.closest(".cell");
      if (cell) { touchStartCell = cell; cell.classList.add("pressed"); }
    }, { passive: true });
    document.addEventListener("touchend", e => {
      const t = e.changedTouches[0];
      const target = document.elementFromPoint(t.clientX, t.clientY)?.closest(".cell");
      if (touchStartCell && target && touchStartCell !== target) {
        swapCandies(touchStartCell, target);
        hideTutorial();
        processBoard();
      }
      if (touchStartCell) touchStartCell.classList.remove("pressed");
      touchStartCell = null;
    });

    function swapCandies(a, b) {
      const imgA = a.querySelector("img");
      const imgB = b.querySelector("img");
      if (imgA && imgB) {
        const tmp = imgA.src;
        imgA.src = imgB.src;
        imgB.src = tmp;
      }
    }

    // ======= TUTORIAL HAND =======
    function positionTutorialHand() {
      const hand = document.getElementById("tutorial-hand");
      const container = document.getElementById("game-container");
      const handW = hand.offsetWidth, handH = hand.offsetHeight;

      hand.style.left = `${container.clientWidth * 0.20 - handW / 2}px`;
      hand.style.top = `${container.clientHeight * 0.20 - handH / 2}px`;
    }

    function hideTutorial() {
      const hand = document.getElementById("tutorial-hand");
      if (hand) hand.style.display = "none";
    }
    window.addEventListener("resize", positionTutorialHand);

    // Init
    createBoard();
  </script>
</body>

</html>